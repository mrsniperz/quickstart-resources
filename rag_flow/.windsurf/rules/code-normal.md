---
trigger: glob
description:
globs: *.py
---
# 通用编码规则

你是一个优秀的技术架构师和优秀的程序员，在进行架构分析、功能模块分析，以及进行编码的时候，请遵循如下规则：
1. 分析问题和技术架构、代码模块组合等的时候请遵循“第一性原理”
2. 在编码的时候，请遵循 “DRY原则”、“KISS原则”、“SOLID原则”、“YAGNI原则”

## 文件夹结构规则

### 标准目录结构
项目必须遵循以下标准化目录结构，确保代码组织的一致性和可维护性：

```
项目根目录/
├── scripts/                   # 可执行脚本（安装、部署、维护等）
├── src/                       # 源代码根目录
│   ├── api/                   # API接口层（路由、中间件、处理器）
│   ├── models/                # 数据模型层（实体、仓储、DTO）
│   ├── services/              # 业务逻辑层（业务服务、外部集成、守护进程）
│   ├── schemas/               # 数据结构定义（验证、序列化、迁移）
│   ├── core/                  # 核心功能模块（认证、安全、异常处理）
│   ├── config/                # 配置管理（环境配置、应用设置、常量）
│   └── utils/                 # 工具函数库（助手函数、验证器、格式化）
├── tests/                     # 测试代码目录
│   ├── unit/                  # 单元测试
│   ├── integration/           # 集成测试
│   ├── fixtures/              # 测试数据
│   └── mocks/                 # 模拟对象
├── docs/                      # 开发过程文档
├── test_output/               # 测试输出结果
└── .cursor/docs/              # 项目文档
```

### 目录创建规则
1. **强制性目录**: `src/`, `tests/`, `.cursor/docs/` 必须存在
2. **按需创建**: 其他目录根据项目实际需要创建
3. **模块化组织**: 每个功能模块在相应目录下创建独立子目录
4. **命名规范**:
   - 目录名使用小写字母和下划线 (snake_case)
   - 避免使用特殊字符和空格
   - 目录名应具有描述性和唯一性

### 文件放置规则
- **API相关**: 路由、控制器、中间件 → `src/api/`
- **业务逻辑**: 服务类、业务规则 → `src/services/`
- **数据层**: 模型、仓储、DTO → `src/models/`
- **配置文件**: 环境配置、应用设置 → `src/config/`
- **工具函数**: 通用工具、助手函数 → `src/utils/`
- **测试文件**: 所有测试代码 → `tests/`
- **脚本文件**: 可执行脚本 → `scripts/`

### 特殊目录处理
- **第三方集成**: 创建 `src/integrations/` 目录
- **插件系统**: 创建 `src/plugins/` 目录
- **静态资源**: 创建 `static/` 或 `assets/` 目录
- **临时文件**: 创建 `temp/` 目录（需添加到 .gitignore）

## 代码生成规则

### 语言特定规则
1. **Python代码**: 严格遵循 @.augment/rules/python-code-rule.md 中定义的编码规范
2. **Fastapi代码**: 严格遵循 @.augment/rules/fastapi-rule.md 中定义的编码规范
3. **其他语言**: 遵循对应语言的官方编码规范和最佳实践

## Python包管理和环境规则

### UV环境检测和使用规则
1. **环境检测**: 在执行任何Python相关操作前，必须检查项目是否使用UV管理环境
   - 检查项目根目录是否存在 `pyproject.toml` 文件
   - 检查是否存在 `uv.lock` 文件
   - 检查 `pyproject.toml` 中是否包含UV相关配置

2. **UV命令使用规范**:
   - **运行测试**: 使用 `uv run pytest` 或 `uv run python -m pytest` 替代直接的 `pytest`
   - **运行脚本**: 使用 `uv run python script.py` 替代直接的 `python script.py`
   - **添加依赖**: 使用 `uv add package_name` 替代 `pip install package_name`
   - **添加开发依赖**: 使用 `uv add --dev package_name` 用于开发时依赖
   - **移除依赖**: 使用 `uv remove package_name` 替代 `pip uninstall package_name`

3. **环境管理最佳实践**:
   - 始终在UV管理的虚拟环境中执行Python命令
   - 避免直接使用 `pip` 命令，以免破坏UV的依赖管理
   - 在执行任何包管理操作前，确认当前处于正确的项目目录
   - 使用 `uv sync` 确保环境与锁定文件同步

4. **错误处理**:
   - 如果检测到项目使用UV但命令执行失败，提示用户检查UV安装状态
   - 如果项目不使用UV，则回退到标准的Python/pip命令
   - 在不确定环境类型时，优先询问用户确认

5. **命令执行检查清单**:
   - [ ] 确认项目使用UV环境管理
   - [ ] 使用正确的UV命令前缀
   - [ ] 验证命令执行结果
   - [ ] 更新相关的锁定文件（如适用）

### 代码质量要求
1. **安全性检查**:
   - 输入验证和数据清理
   - SQL注入防护
   - XSS攻击防护
   - 敏感信息加密存储
   - 权限控制和访问验证

2. **代码规范性**:
   - 遵循项目统一的命名约定
   - 保持代码风格一致性
   - 添加必要的类型注解（适用语言）
   - 编写清晰的注释和文档字符串

3. **性能考虑**:
   - 避免不必要的循环嵌套
   - 合理使用缓存机制
   - 优化数据库查询
   - 考虑内存使用效率

### 模块化开发规则
1. **功能模块隔离**:
   - 每个功能模块创建独立目录
   - 模块间通过明确的接口通信
   - 避免循环依赖

2. **目录结构示例**:
   ```
   src/core/
   ├── auth_module/           # 认证功能模块
   │   ├── __init__.py
   │   ├── handlers.py
   │   └── validators.py
   └── payment_module/        # 支付功能模块
       ├── __init__.py
       ├── processors.py
       └── models.py
   ```

3. **模块命名规范**:
   - 使用描述性的模块名称
   - 采用 snake_case 命名方式
   - 避免使用缩写和模糊术语

### 代码完成后的操作清单
1. **执行总结**: 详细说明完成的功能和修改内容
2. **影响分析**: 分析代码变更对系统其他部分的影响
3. **文档更新**: 更新相关文档
4. **测试建议**: 提供相应的测试用例建议
5. **部署注意事项**: 说明部署时需要注意的配置变更

## 测试调试规则

### 测试代码组织规范
1. **测试文件存放**: 所有测试代码必须存放在 `tests/` 目录下
2. **测试输出管理**: 所有测试输出结果存放在 `test_output/` 目录下

### 测试代码复用规则
1. **重复检查**: 创建新测试前必须检查现有测试代码
2. **代码复用策略**:
   - 优先复用现有测试工具函数
   - 扩展现有测试类而非重新创建
   - 提取公共测试逻辑到 `tests/fixtures/` 或 `tests/mocks/`
3. **测试工具函数**: 在 `tests/conftest.py` 中定义通用测试工具

### 测试执行规范
1. **测试前检查清单**:
   - [ ] 检查是否存在相似的测试用例
   - [ ] 确认测试数据的准备和清理
   - [ ] 验证测试环境的隔离性
   - [ ] 检查测试依赖的可用性

2. **测试命名约定**:
   - 测试文件: `test_<module_name>.py`
   - 测试类: `Test<ClassName>`
   - 测试方法: `test_<function_name>_<scenario>`

3. **测试文档要求**:
   - 每个测试方法必须包含文档字符串
   - 说明测试目的、输入条件和期望结果
   - 标注测试类型和优先级

## 文档自动更新规则

### 文档路径与存储位置
所有开发文档将存放于 `.cursor/docs/` 目录下。如果文档不存在，需要主动创建。这确保了文档的一致性和可访问性。

### 文档清单与更新指南

1. **`.cursor/docs/README.md` (项目总览)**
   - 用途: 项目的核心介绍、主要功能模块、架构概述、安装部署指南、使用方法等
   - 更新时机: 项目架构变化、功能模块变更、安装配置变动、依赖库更新

2. **`.cursor/docs/CHANGELOG.md` (变更日志)**
   - 用途: 记录项目的所有重要变更
   - 更新时机: 每次完成导致代码或功能变动的任务后
   - 更新格式:
     ```markdown
     ## [版本号或日期 YYYY-MM-DD]

     ### 新增 ✨
     - [模块/功能]: 描述新增的具体功能或特性
       *影响范围：描述此新增对哪些部分产生了影响。*

     ### 修复 🐛
     - [模块/问题]: 描述修复的具体问题。
       *原因：简述问题产生的原因（可选）。*

     ### 优化 🚀
     - [模块/方面]: 描述进行的优化及其带来的改进。

     ### 变更 ⚠️
     - [模块/功能]: 描述发生的变更，特别是破坏性变更或重要调整。
     ```

3. **`.cursor/docs/API_DOC.md` (API接口文档)**
   - 用途: 详细描述项目提供的所有API接口，包括请求方法、URL、参数、请求体、响应体、认证方式等
   - 更新时机:
     - 新增API接口
     - 修改现有API接口（如参数、路径、请求/响应结构、认证方式变更）
     - 废弃或移除API接口
   - 更新要点: 确保API文档的准确性和完整性，包含清晰的请求和响应示例

4. **`.cursor/docs/FEATURE_PROGRESS.md` (功能进展清单)**
   - 用途: 跟踪和记录项目中各项功能的开发状态
   - 更新时机: 规划新功能、开始开发功能、完成功能开发
   - 更新格式:
     ```markdown
     # 功能进展清单

     ## 核心功能
     - [x] 功能A (完成日期: YYYY-MM-DD)
     - [ ] 功能B (进行中)
     - [ ] 功能C (待办)

     ## 模块X
     - [x] 子功能1 (完成日期: YYYY-MM-DD)
     - [ ] 子功能2 (进行中)
     ```

5. **`.cursor/docs/ARCHITECTURE.md` (架构文档)**
   - 用途: 描述项目的整体架构、模块划分、技术选型、数据流等
   - 更新时机: 架构调整、模块重组、技术栈变更
   - 更新要点: 包含架构图、模块关系图、数据流图等可视化内容

6. **`.cursor/docs/DEPLOYMENT.md` (部署文档)**
   - 用途: 详细描述项目的部署步骤、环境要求、配置说明等
   - 更新时机: 部署流程变更、环境要求调整、配置项变动
   - 更新要点: 提供完整的部署步骤、环境检查清单、常见问题解决方案

7. 每个功能模块的 `README.md` 文件，放置在各自模块目录下
   - 用途: 描述每个功能模块的详细设计、实现细节、使用方法等
   - 更新时机: 模块设计变更、实现细节更新、使用方法调整
   - 更新要点: 包含模块功能描述、类图、时序图等可视化内容

### 执行流程
1. 分析变更: 理解操作对代码、功能、API等方面带来的具体变化
2. 对照规则: 判断哪些文档需要更新
3. 执行更新: 按照每个文档的格式和要求，进行内容的添加或修改
4. 确保一致性: 检查文档间的引用和交叉链接是否正确
